<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Pertov Recipe Book</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-body::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: #555; }
        .hidden { display: none; }
        .summary-arrow { transition: transform 0.2s ease-in-out; }
        details[open] .summary-arrow { transform: rotate(180deg); }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Login Screen -->
    <div id="login-screen" class="flex flex-col items-center justify-center h-screen p-4">
        <h1 class="text-4xl font-bold text-gray-800 mb-4 text-center">The Pertov Recipe Book</h1>
        <p class="text-gray-600 mb-8 text-center">Sign in to save and access your recipes from anywhere.</p>
        <div id="config-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6 max-w-md text-center">
            <strong class="font-bold">Configuration Error!</strong>
            <span class="block sm:inline">Please add your Firebase configuration details to the code.</span>
        </div>
        <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full flex items-center shadow-lg transition-transform transform hover:scale-105">
            <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
            Sign in with Google
        </button>
    </div>

    <!-- Main App Container (hidden by default) -->
    <div id="app" class="max-w-4xl mx-auto hidden">
        <!-- Header -->
        <header class="flex justify-between items-center p-6 bg-white border-b border-gray-200 sticky top-0 z-10">
            <h1 class="text-3xl font-bold text-gray-800">The Pertov Recipe Book</h1>
            <div class="flex items-center">
                <button id="add-recipe-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full flex items-center shadow-md transition-transform transform hover:scale-105 mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Recipe
                </button>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full flex items-center shadow-md transition-transform transform hover:scale-105">
                    Sign Out
                </button>
            </div>
        </header>

        <!-- Search Bar -->
        <div class="p-6">
            <div class="relative">
                <input id="search-input" type="text" placeholder="Search recipes..." class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div>
        </div>

        <!-- Recipe List Container -->
        <main id="recipe-list-container" class="p-6 space-y-8">
            <div id="app-loader" class="flex justify-center items-center py-20">
                <div class="loader"></div>
            </div>
        </main>
    </div>

    <!-- Modals (Add/Edit, View, Delete) -->
    <div id="recipe-form-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all scale-95 opacity-0" id="recipe-form-modal-content">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 id="recipe-form-title" class="text-2xl font-bold text-gray-800">Add New Recipe</h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <form id="recipe-form" class="p-6 space-y-4 modal-body overflow-y-auto max-h-[70vh]">
                <input type="hidden" id="recipe-id">
                <input type="text" id="recipe-name" placeholder="Recipe Name (e.g., Classic Pancakes)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="text" id="recipe-meal-type" placeholder="Meal Type (e.g., Breakfast, Lunch)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="text" id="recipe-cuisine" placeholder="Cuisine (e.g., American, Asian)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <select id="recipe-heaviness" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="" disabled selected>Select Meal Heaviness</option>
                    <option value="light">Light</option>
                    <option value="medium">Medium</option>
                    <option value="heavy">Heavy</option>
                </select>
                <input type="url" id="recipe-image-url" placeholder="Image URL (optional)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <textarea id="recipe-ingredients" placeholder="Ingredients (comma separated)" class="w-full p-3 border border-gray-300 rounded-lg h-24 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                <textarea id="recipe-instructions" placeholder="Instructions" class="w-full p-3 border border-gray-300 rounded-lg h-32 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                <textarea id="recipe-details" placeholder="Additional details or notes..." class="w-full p-3 border border-gray-300 rounded-lg h-24 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </form>
             <div class="p-6 border-t border-gray-200">
                <button type="submit" form="recipe-form" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Save Recipe</button>
            </div>
        </div>
    </div>
    <div id="view-recipe-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all scale-95 opacity-0" id="view-modal-content">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 id="view-recipe-name" class="text-2xl font-bold text-gray-800"></h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-6 space-y-6 modal-body overflow-y-auto max-h-[70vh]">
                <img id="view-recipe-image" src="" alt="Recipe Image" class="w-full h-64 object-cover rounded-lg mb-4 hidden" onerror="this.classList.add('hidden')">
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Ingredients</h3>
                    <ul id="view-recipe-ingredients" class="list-disc list-inside space-y-1 text-gray-600"></ul>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Instructions</h3>
                    <p id="view-recipe-instructions" class="text-gray-600 whitespace-pre-wrap"></p>
                </div>
                <div id="view-recipe-details-container" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Details</h3>
                    <p id="view-recipe-details" class="text-gray-600 whitespace-pre-wrap"></p>
                </div>
            </div>
        </div>
    </div>
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform transition-all scale-95 opacity-0" id="delete-modal-content">
            <div class="p-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-red-500 mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                <h3 class="text-lg font-bold text-gray-800">Delete Recipe?</h3>
                <p class="text-gray-600 my-2">Are you sure you want to delete this recipe? This action cannot be undone.</p>
            </div>
            <div class="flex justify-center items-center p-4 bg-gray-50 rounded-b-2xl">
                <button id="cancel-delete-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg mr-4">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Your Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9vCnx6Zk2lUxDksWk1D9y03mzJCkxdDA",
            authDomain: "recipebook-f66d1.firebaseapp.com",
            projectId: "recipebook-f66d1",
            storageBucket: "recipebook-f66d1.appspot.com",
            messagingSenderId: "280083068960",
            appId: "1:280083068960:web:04ed6d6515e5c0b44ce445"
        };
        
        // --- Configuration Check ---
        // This check ensures that the user has replaced the placeholder Firebase config.
        // If not, it displays an error message and disables the login button.
        const configErrorDiv = document.getElementById('config-error');
        const loginBtn = document.getElementById('login-btn');

        if (firebaseConfig.apiKey.startsWith("YOUR_") || firebaseConfig.projectId.startsWith("YOUR_")) {
            configErrorDiv.classList.remove('hidden');
            loginBtn.disabled = true;
            loginBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let recipes = {};
        let userId = null;
        let recipeToDeleteId = null;

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app');
        const logoutBtn = document.getElementById('logout-btn');
        const recipeListContainer = document.getElementById('recipe-list-container');
        const appLoader = document.getElementById('app-loader');
        const recipeFormModal = document.getElementById('recipe-form-modal');
        const recipeFormModalContent = document.getElementById('recipe-form-modal-content');
        const viewRecipeModal = document.getElementById('view-recipe-modal');
        const viewModalContent = document.getElementById('view-modal-content');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteModalContent = document.getElementById('delete-modal-content');
        const addRecipeBtn = document.getElementById('add-recipe-btn');
        const recipeForm = document.getElementById('recipe-form');
        const searchInput = document.getElementById('search-input');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                userId = user.uid;
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                await loadRecipes();
            } else {
                // User is signed out
                userId = null;
                recipes = {};
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        // Firebase Functions
        const loadRecipes = async () => {
            if (!userId) return;
            appLoader.classList.remove('hidden');
            recipeListContainer.innerHTML = ''; // Clear previous content
            recipeListContainer.appendChild(appLoader);

            const docRef = doc(db, "users", userId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                recipes = docSnap.data().recipes || {};
            } else {
                // New user, create an empty document
                recipes = {};
                await saveRecipes();
            }
            appLoader.classList.add('hidden');
            renderRecipes();
        };

        const saveRecipes = async () => {
            if (!userId) return;
            try {
                await setDoc(doc(db, "users", userId), { recipes });
            } catch (e) {
                console.error("Error saving recipes: ", e);
                alert("Could not save recipes. Please check your connection and try again.");
            }
        };

        // Event Listeners
        loginBtn.addEventListener('click', () => {
            if (loginBtn.disabled) return;
            signInWithPopup(auth, provider).catch((error) => {
                console.error("Authentication error:", error);
                alert(`Login failed: ${error.message}`);
            });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });
        
        // --- The rest of the app logic remains largely the same ---
        // --- but now calls saveRecipes() after any modification. ---

        const getHeavinessColor = (heaviness) => {
            switch (heaviness) {
                case 'light': return 'bg-green-100 hover:bg-green-200';
                case 'medium': return 'bg-yellow-100 hover:bg-yellow-200';
                case 'heavy': return 'bg-red-100 hover:bg-red-200';
                default: return 'bg-gray-100 hover:bg-gray-200';
            }
        };

        const createRecipeCard = (recipe) => `
            <div class="recipe-card-container flex items-center justify-between p-4 rounded-lg cursor-pointer transition ${getHeavinessColor(recipe.heaviness)}" data-recipe-id='${recipe.id}'>
                <div class="recipe-card-view flex-grow flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 mr-4"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                    <span class="font-medium text-gray-800">${recipe.name}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="edit-recipe-btn p-2 rounded-full hover:bg-gray-300 transition" data-recipe-id='${recipe.id}'><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                    <button class="delete-recipe-btn p-2 rounded-full hover:bg-gray-300 transition" data-recipe-id='${recipe.id}'><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                </div>
            </div>`;
        
        const createCuisineSection = (cuisine, recipeList) => `
            <div class="bg-white rounded-xl shadow-sm p-5">
                <details open>
                    <summary class="flex justify-between items-center cursor-pointer font-semibold text-lg text-gray-800">${cuisine}<svg class="summary-arrow w-6 h-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></summary>
                    <div class="mt-4 space-y-3">${recipeList.map(createRecipeCard).join('')}</div>
                </details>
            </div>`;

        const createMealTypeSection = (mealType, cuisines) => `
            <section>
                <h2 class="text-2xl font-bold text-gray-700 mb-4">${mealType}</h2>
                <div class="space-y-4">${Object.entries(cuisines).map(([cuisine, recipeList]) => createCuisineSection(cuisine, recipeList)).join('')}</div>
            </section>`;

        const renderRecipes = (filteredRecipes = recipes) => {
            if (appLoader.parentElement) appLoader.remove();
            recipeListContainer.innerHTML = Object.keys(filteredRecipes).length > 0 
                ? Object.entries(filteredRecipes).map(([mealType, cuisines]) => createMealTypeSection(mealType, cuisines)).join('')
                : `<p class="text-center text-gray-500 py-10">No recipes yet. Click "Add Recipe" to get started!</p>`;
            
            document.querySelectorAll('.recipe-card-view').forEach(card => {
                card.closest('.recipe-card-container').addEventListener('click', (e) => {
                    if (e.target.closest('.edit-recipe-btn') || e.target.closest('.delete-recipe-btn')) return;
                    const recipeId = card.closest('.recipe-card-container').dataset.recipeId;
                    const recipe = findRecipeById(recipeId);
                    if(recipe) showViewModal(recipe);
                });
            });
            document.querySelectorAll('.edit-recipe-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showEditModal(btn.dataset.recipeId);
            }));
            document.querySelectorAll('.delete-recipe-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showDeleteConfirmModal(btn.dataset.recipeId);
            }));
        };
        
        const openModal = (modal, content) => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        const closeModal = (modal, content) => {
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        const showAddModal = () => {
            recipeForm.reset();
            document.getElementById('recipe-id').value = '';
            document.getElementById('recipe-form-title').textContent = 'Add New Recipe';
            openModal(recipeFormModal, recipeFormModalContent);
        };

        const showEditModal = (recipeId) => {
            const { recipe } = findRecipeById(recipeId);
            if (!recipe) return;
            
            document.getElementById('recipe-id').value = recipe.id;
            document.getElementById('recipe-name').value = recipe.name;
            document.getElementById('recipe-meal-type').value = findMealTypeByRecipeId(recipeId);
            document.getElementById('recipe-cuisine').value = findCuisineByRecipeId(recipeId);
            document.getElementById('recipe-heaviness').value = recipe.heaviness;
            document.getElementById('recipe-image-url').value = recipe.imageUrl || '';
            document.getElementById('recipe-ingredients').value = recipe.ingredients.join(', ');
            document.getElementById('recipe-instructions').value = recipe.instructions;
            document.getElementById('recipe-details').value = recipe.details || '';
            document.getElementById('recipe-form-title').textContent = 'Edit Recipe';

            openModal(recipeFormModal, recipeFormModalContent);
        };
        
        const showViewModal = ({ recipe }) => {
            document.getElementById('view-recipe-name').textContent = recipe.name;
            const imageView = document.getElementById('view-recipe-image');
            if (recipe.imageUrl) {
                imageView.src = recipe.imageUrl;
                imageView.classList.remove('hidden');
            } else {
                imageView.classList.add('hidden');
            }
            const ingredientsList = document.getElementById('view-recipe-ingredients');
            ingredientsList.innerHTML = recipe.ingredients.map(ing => `<li>${ing}</li>`).join('');
            document.getElementById('view-recipe-instructions').textContent = recipe.instructions;
            const detailsContainer = document.getElementById('view-recipe-details-container');
            const detailsView = document.getElementById('view-recipe-details');
            if (recipe.details) {
                detailsView.textContent = recipe.details;
                detailsContainer.classList.remove('hidden');
            } else {
                detailsContainer.classList.add('hidden');
            }
            openModal(viewRecipeModal, viewModalContent);
        };

        const showDeleteConfirmModal = (recipeId) => {
            recipeToDeleteId = recipeId;
            openModal(deleteConfirmModal, deleteModalContent);
        };

        addRecipeBtn.addEventListener('click', showAddModal);

        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                closeModal(recipeFormModal, recipeFormModalContent);
                closeModal(viewRecipeModal, viewModalContent);
            });
        });
        
        recipeFormModal.addEventListener('click', (e) => { if(e.target === recipeFormModal) closeModal(recipeFormModal, recipeFormModalContent); });
        viewRecipeModal.addEventListener('click', (e) => { if(e.target === viewRecipeModal) closeModal(viewRecipeModal, viewModalContent); });
        deleteConfirmModal.addEventListener('click', (e) => { if(e.target === deleteConfirmModal) closeModal(deleteConfirmModal, deleteModalContent); });
        
        recipeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const recipeId = document.getElementById('recipe-id').value;
            const name = document.getElementById('recipe-name').value;
            const mealType = document.getElementById('recipe-meal-type').value.trim();
            const cuisine = document.getElementById('recipe-cuisine').value.trim();
            const heaviness = document.getElementById('recipe-heaviness').value;
            const imageUrl = document.getElementById('recipe-image-url').value.trim();
            const ingredients = document.getElementById('recipe-ingredients').value.split(',').map(i => i.trim());
            const instructions = document.getElementById('recipe-instructions').value;
            const details = document.getElementById('recipe-details').value.trim();

            if (recipeId) { deleteRecipe(recipeId, false); }
            
            const newOrUpdatedRecipe = {
                id: recipeId || Date.now().toString(),
                name, ingredients, instructions, heaviness, imageUrl, details
            };

            if (!recipes[mealType]) recipes[mealType] = {};
            if (!recipes[mealType][cuisine]) recipes[mealType][cuisine] = [];
            recipes[mealType][cuisine].push(newOrUpdatedRecipe);

            await saveRecipes();
            renderRecipes();
            closeModal(recipeFormModal, recipeFormModalContent);
        });
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) { renderRecipes(recipes); return; }
            const filtered = Object.entries(recipes).reduce((acc, [meal, cuisines]) => {
                const filteredCuisines = Object.entries(cuisines).reduce((cuisineAcc, [cuisine, recipeList]) => {
                    const matchingRecipes = recipeList.filter(recipe => recipe.name.toLowerCase().includes(searchTerm));
                    if(matchingRecipes.length > 0) cuisineAcc[cuisine] = matchingRecipes;
                    return cuisineAcc;
                }, {});
                if(Object.keys(filteredCuisines).length > 0) acc[meal] = filteredCuisines;
                return acc;
            }, {});
            renderRecipes(filtered);
        });

        cancelDeleteBtn.addEventListener('click', () => closeModal(deleteConfirmModal, deleteModalContent));
        confirmDeleteBtn.addEventListener('click', async () => {
            if (recipeToDeleteId) {
                deleteRecipe(recipeToDeleteId);
                await saveRecipes();
                recipeToDeleteId = null;
            }
            closeModal(deleteConfirmModal, deleteModalContent);
        });

        const findRecipeById = (id) => {
            for (const mealType in recipes) {
                for (const cuisine in recipes[mealType]) {
                    const recipe = recipes[mealType][cuisine].find(r => r.id === id);
                    if (recipe) return { recipe, mealType, cuisine };
                }
            }
            return null;
        };
        const findMealTypeByRecipeId = (id) => findRecipeById(id)?.mealType;
        const findCuisineByRecipeId = (id) => findRecipeById(id)?.cuisine;

        const deleteRecipe = (id, shouldRender = true) => {
            const location = findRecipeById(id);
            if (location) {
                const { mealType, cuisine } = location;
                recipes[mealType][cuisine] = recipes[mealType][cuisine].filter(r => r.id !== id);
                if (recipes[mealType][cuisine].length === 0) delete recipes[mealType][cuisine];
                if (Object.keys(recipes[mealType]).length === 0) delete recipes[mealType];
                if (shouldRender) renderRecipes();
            }
        };
    </script>
</body>
</html>
